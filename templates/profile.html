<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å - {{ login }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="profile-header">
            <div>
                <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ login }}!</h1>
                <div class="user-role-badge">
                    {% if is_superadmin %}
                    <span class="superadmin-badge">üëë –°—É–ø–µ—Ä–∞–¥–º–∏–Ω</span>
                    {% elif is_admin %}
                    <span class="admin-badge">üõ°Ô∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                    {% else %}
                    <span class="student-badge">üéì –£—á–µ–Ω–∏–∫</span>
                    {% endif %}
                </div>
            </div>
            <div class="coins-badge">
                üí∞ {{ coins }} –º–æ–Ω–µ—Ç
            </div>
        </div>

        {% if not is_admin %}
        <div class="user-info">
            <div class="info-card">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–∏–ª–µ</h3>
                <p><strong>–ö–ª–∞—Å—Å:</strong> <span class="highlight">{{ user[5] if user[5] else '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span></p>
                <p><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> <span class="highlight">
                    {% if user[6] %}
                        {% if user[6] == 'math' %}–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
                        {% elif user[6] == 'bio' %}–ë–∏–æ–ª–æ–≥–∏—è
                        {% elif user[6] == 'eng' %}–ò–Ω–∂–µ–Ω–µ—Ä–∏—è
                        {% elif user[6] == 'hum' %}–ì—É–º–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ
                        {% elif user[6] == 'it' %}IT
                        {% else %}{{ user[6] }}{% endif %}
                    {% else %}–ù–µ —É–∫–∞–∑–∞–Ω–æ{% endif %}
                </span></p>
                <p><strong>–†–æ–ª—å:</strong> <span class="highlight">
                    {% if user[7] == 'teacher' %}–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å
                    {% else %}–£—á–µ–Ω–∏–∫{% endif %}
                </span></p>
            </div>
        </div>

        <div class="chart-container">
            <h2>üìà –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–Ω–µ—Ç</h2>
            <div id="coinsChart"></div>
        </div>
        {% endif %}

        {% if message %}
        <div class="toast show" id="toast">{{ message }}</div>
        {% endif %}

        {% if is_admin %}
        <div class="admin-panel">
            <div class="control-column">
                <h2 class="control-header">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞–º–∏</h2>
                <div class="table-container">
                    <table class="class-table">
                        <thead>
                            <tr>
                                <th>–ö–ª–∞—Å—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for class in [7,8,9,10,11] %}
                            <tr>
                                <td>{{ class }} –∫–ª–∞—Å—Å</td>
                                <td>
                                    <button class="modern-btn table-btn" onclick="loadDirections('{{ class }}')">
                                        –í—ã–±—Ä–∞—Ç—å
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div id="direction-list" style="display: none;">
                    <h3 class="control-header">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è <span id="selected-class"></span> –∫–ª–∞—Å—Å–∞</h3>
                    <div class="table-container">
                        <table class="direction-table">
                            <tbody>
                                <tr>
                                    <td>IT</td>
                                    <td><button class="modern-btn table-btn" onclick="loadUsers('it')">–ü–æ–∫–∞–∑–∞—Ç—å</button></td>
                                </tr>
                                <tr>
                                    <td>–ë–∏–æ</td>
                                    <td><button class="modern-btn table-btn" onclick="loadUsers('bio')">–ü–æ–∫–∞–∑–∞—Ç—å</button></td>
                                </tr>
                                <tr>
                                    <td>–ú–∞—Ç</td>
                                    <td><button class="modern-btn table-btn" onclick="loadUsers('math')">–ü–æ–∫–∞–∑–∞—Ç—å</button></td>
                                <tr>
                                    <td>–ò–Ω–∂</td>
                                    <td><button class="modern-btn table-btn" onclick="loadUsers('eng')">–ü–æ–∫–∞–∑–∞—Ç—å</button></td>
                                </tr>
                                <tr>
                                    <td>–ì—É–º</td>
                                    <td><button class="modern-btn table-btn" onclick="loadUsers('hum')">–ü–æ–∫–∞–∑–∞—Ç—å</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="control-column">
                <div id="user-list" style="display: none;">
                    <h3 class="control-header">
                        <span id="class-name"></span>
                        <span id="direction-name"></span>
                    </h3>

                    <div class="coin-controls-vertical">
                        <div class="coin-control-section">
                            <h4>‚ûï –ü—Ä–∏–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç</h4>
                            <form id="update-coins-form" action="/update_coins" method="POST">
                                <input type="hidden" name="admin_id" value="{{ user_id }}">
                                <div id="users-container" class="users-list"></div>
                                <div class="form-group">
                                    <input type="number"
                                        id="add_coins"
                                        name="add_coins"
                                        class="coin-input"
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                                        min="1"
                                        required>
                                </div>
                                <button type="submit" class="modern-btn add-btn">
                                    –ü—Ä–∏–±–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã
                                </button>
                            </form>
                        </div>

                        <div class="coin-control-section">
                            <h4>‚ûñ –£–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç</h4>
                            <form id="subtract-coins-form" action="/subtract_coins" method="POST">
                                <input type="hidden" name="admin_id" value="{{ user_id }}">
                                <div id="users-container-subtract" class="users-list"></div>
                                <div class="form-group">
                                    <input type="number"
                                        id="subtract_coins"
                                        name="subtract_coins"
                                        class="coin-input"
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                                        min="1"
                                        required>
                                </div>
                                <button type="submit" class="modern-btn remove-btn">
                                    –£–±–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if is_superadmin %}
        <div class="admin-section">
            <h2 class="control-header">üëë –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <form action="/make_admin" method="POST">
                <input type="hidden" name="superadmin_id" value="{{ user_id }}">
                <div class="form-group">
                    <input type="text"
                        id="user_login_admin"
                        name="user_login"
                        class="coin-input"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                        required>
                </div>
                <button type="submit" class="modern-btn add-btn">
                    –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
                </button>
            </form>
        </div>
        {% endif %}

        <div class="logout-container">
            <a href="/logout" class="logout-button">üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</a>
        </div>
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
            fetch('/check_auth', {
                credentials: 'include'
            }).then(response => {
                if (!response.ok) {
                    window.location.href = '/';
                }
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            initChart();

            // –ü–æ–∫–∞–∑–∞—Ç—å toast —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (document.getElementById('toast')) {
                setTimeout(() => {
                    document.getElementById('toast').classList.remove('show');
                }, 3000);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ Plotly
        function initChart() {
            const data = [{
                x: {{ labels | tojson }},
                y: {{ coins_data | tojson }},
                type: 'scatter',
                mode: 'lines+markers',
                marker: {
                    color: '#4cc9f0',
                    size: 8
                },
                line: {
                    color: '#4361ee',
                    width: 3,
                    shape: 'spline'
                }
            }];

            const layout = {
                title: '–î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–Ω–µ—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü',
                xaxis: {
                    title: '–î–∞—Ç–∞',
                    gridcolor: '#2a3a5a',
                    tickfont: { color: '#e0e0e0' },
                    titlefont: { color: '#e0e0e0' }
                },
                yaxis: {
                    title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç',
                    gridcolor: '#2a3a5a',
                    tickfont: { color: '#e0e0e0' },
                    titlefont: { color: '#e0e0e0' },
                    rangemode: 'tozero'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                margin: { t: 40, l: 60, r: 40, b: 60 },
                hovermode: 'closest'
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['toImage', 'sendDataToCloud']
            };

            Plotly.newPlot('coinsChart', data, layout, config);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        let selectedClass = '';

        function loadDirections(className) {
            selectedClass = className;
            document.getElementById('direction-list').style.display = 'block';
            document.getElementById('selected-class').textContent = className;
            document.getElementById('user-list').style.display = 'none';
        }

        function loadUsers(direction) {
            fetch(`/get_users_by_class_and_direction?class=${selectedClass}&direction=${direction}`, {
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                return response.json();
            })
            .then(data => {
                const containers = [
                    document.getElementById('users-container'),
                    document.getElementById('users-container-subtract')
                ];

                containers.forEach(container => {
                    container.innerHTML = data.users.map(user => `
                        <label class="user-checkbox">
                            <input type="checkbox" name="user_ids" value="${user.id}">
                            ${user.login} (${user.quantity_of_coins} üí∞)
                        </label>
                    `).join('');
                });

                document.getElementById('user-list').style.display = 'block';
                document.getElementById('class-name').textContent = `${selectedClass} –∫–ª–∞—Å—Å`;
                document.getElementById('direction-name').textContent = ` / ${getDirectionName(direction)}`;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            });
        }

        function getDirectionName(direction) {
            const directions = {
                'it': 'IT',
                'bio': '–ë–∏–æ',
                'math': '–ú–∞—Ç',
                'eng': '–ò–Ω–∂',
                'hum': '–ì—É–º'
            };
            return directions[direction] || direction;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º
        document.getElementById('update-coins-form')?.addEventListener('submit', function(e) {
            if (!validateCoinForm(this)) e.preventDefault();
        });

        document.getElementById('subtract-coins-form')?.addEventListener('submit', function(e) {
            if (!validateCoinForm(this)) e.preventDefault();
        });

        function validateCoinForm(form) {
            const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return false;
            }
            return true;
        }
    </script>
</body>
</html>
